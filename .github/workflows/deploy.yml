name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

jobs:
  set-up:
    runs-on: ubuntu-latest
    steps:

    - name: Note Build Start Time
      id : start_time
      run : echo "START_TIME=$(date +%s)" >> $GITHUB_ENV
      
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Decode & Restore Service Account Key
      run: echo "${{ secrets.GCP_SA_KEY }}" | base64 --decode > blinker-backend-key.json

    - name: Authenticate with GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: "${{ secrets.GCP_SA_KEY }}"

    - name: Configure Docker Authentication
      run: gcloud auth configure-docker asia-northeast3-docker.pkg.dev

  build:
    runs-on: ubuntu-latest
    steps:

    - name: Build Docker Image
      run: docker build -t asia-northeast3-docker.pkg.dev/blinker-backend/blinker-repo/blinker-backend:latest .

    - name: Push Docker Image to Artifact Registry
      run: docker push asia-northeast3-docker.pkg.dev/blinker-backend/blinker-repo/blinker-backend:latest

  deploy:
    runs-on : ubuntu-latest
    steps:

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy blinker-backend \
          --image=asia-northeast3-docker.pkg.dev/blinker-backend/blinker-repo/blinker-backend:latest \
          --platform=managed \
          --region=asia-northeast3 \
          --allow-unauthenticated \
          --add-cloudsql-instances=blinker-db:asia-northeast3:blinker-atom-db \
          --set-env-vars SPRING_PROFILES_ACTIVE=prod \
          --set-env-vars GOOGLE_APPLICATION_CREDENTIALS=/app/blinker-backend-key.json

  notification:
    runs-on : ubuntu-latest
    steps:

    - name: ì¢…ë£Œ ì‹œê°„ ê¸°ë¡
      id: end_time
      run: echo "BUILD_TIME=$(( $(date +%s) - $START_TIME ))" >> $GITHUB_ENV

    - name: ë¹Œë“œ ì„±ê³µ Discord ì•Œë¦¼
      if: success()
      uses: tsickert/discord-webhook@v6.0.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
        embed-title: "âœ… **ë°°í¬ ì„±ê³µ.**"
        embed-url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        embed-description: |
          ğ‘’ **ë°°í¬ í™˜ê²½:** `prod`
          ğ˜£ **ëŒ€ìƒ ë¸Œëœì¹˜:** `${{ github.ref_name }}`
          ğ‘¡ **ì†Œìš” ì‹œê°„:** `${{ env.BUILD_TIME }}ì´ˆ`
          ğ’ˆ **ì•¡ì…˜ ë§í¬:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        embed-color: "3066993"

    - name: ë¹Œë“œ ì‹¤íŒ¨ Discord ì•Œë¦¼
      if: failure()
      uses: tsickert/discord-webhook@v6.0.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
        embed-title: "ğŸŒ‹ **ë°°í¬ ì‹¤íŒ¨.**"
        embed-url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        embed-description: |
          ğ‘’ **ë°°í¬ í™˜ê²½:** `prod`
          ğ˜£ **ëŒ€ìƒ ë¸Œëœì¹˜:** `${{ github.ref_name }}`
          ğ‘¡ **ì†Œìš” ì‹œê°„:** `${{ env.BUILD_TIME }}ì´ˆ`
          ğ’ˆ **ì•¡ì…˜ ë§í¬:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        embed-color: "16711680"