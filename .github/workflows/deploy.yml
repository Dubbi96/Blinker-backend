name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

    - name: Note Build Start Time
    id : start_time
    run : echo "START_TIME=$(date +%s)" >> $GITHUB_ENV
      
      - name: 1Ô∏è‚É£ Checkout Repository
      uses: actions/checkout@v3

    - name: 2Ô∏è‚É£ Decode & Restore Service Account Key
      run: echo "${{ secrets.GCP_SA_KEY }}" | base64 --decode > blinker-backend-key.json

    - name: 3Ô∏è‚É£ Authenticate with GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: "${{ secrets.GCP_SA_KEY }}"

    - name: 4Ô∏è‚É£ Configure Docker Authentication
      run: gcloud auth configure-docker asia-northeast3-docker.pkg.dev

    - name: 5Ô∏è‚É£ Build Docker Image
      run: docker build -t asia-northeast3-docker.pkg.dev/blinker-backend/blinker-repo/blinker-backend:latest .

    - name: 6Ô∏è‚É£ Push Docker Image to Artifact Registry
      run: docker push asia-northeast3-docker.pkg.dev/blinker-backend/blinker-repo/blinker-backend:latest

    - name: 7Ô∏è‚É£ Deploy to Cloud Run
      run: |
        gcloud run deploy blinker-backend \
          --image=asia-northeast3-docker.pkg.dev/blinker-backend/blinker-repo/blinker-backend:latest \
          --platform=managed \
          --region=asia-northeast3 \
          --allow-unauthenticated \
          --add-cloudsql-instances=blinker-db:asia-northeast3:blinker-atom-db \
          --set-env-vars SPRING_PROFILES_ACTIVE=prod \
          --set-env-vars GOOGLE_APPLICATION_CREDENTIALS=/app/blinker-backend-key.json

    - name: Ï¢ÖÎ£å ÏãúÍ∞Ñ Í∏∞Î°ù
      id: end_time
      run: echo "END_TIME=$(date +%s)" >> $GITHUB_ENV

    - name: ÎπåÎìú ÏÑ±Í≥µ Slack ÏïåÎ¶º
      if: success()
      run: |
        BUILD_TIME=$((END_TIME - START_TIME))
        curl -X POST -H 'Content-type: application/json' \
        --data '{
        "text": "‚úÖ *Î∞∞Ìè¨ ÏÑ±Í≥µ!* üéâ",
        "attachments": [
         {
           "color": "#36a64f",
           "fields": [
             { "title": "Status", "value": "ÏÑ±Í≥µ ‚úÖ", "short": true },
             { "title": "Branch", "value": "${{ github.ref }}", "short": true },
             { "title": "Build Time", "value": "'"$BUILD_TIME"Ï¥à'", "short": true },
             { "title": "Committer", "value": "${{ github.actor }}", "short": true }
           ]
         }
        ]
        }' \
        https://hooks.slack.com/services/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

    - name: ÎπåÎìú Ïã§Ìå® Slack ÏïåÎ¶º
      if: failure()
      run: |
        BUILD_TIME=$((END_TIME - START_TIME))
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "‚ùå *Î∞∞Ìè¨ Ïã§Ìå®!* üö®",
          "attachments": [
            {
              "color": "#ff0000",
              "fields": [
                { "title": "Status", "value": "Ïã§Ìå® ‚ùå", "short": true },
                { "title": "Branch", "value": "${{ github.ref }}", "short": true },
                { "title": "Build Time", "value": "'"$BUILD_TIME"Ï¥à'", "short": true },
                { "title": "Committer", "value": "${{ github.actor }}", "short": true }
              ]
            }
          ]
        }' \
        https://hooks.slack.com/services/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